%%%
%%%               ejabberd configuration file
%%%
%%%'


%%%.   =======================
%%%'   OVERRIDE STORED OPTIONS

%%
%% Override the old values stored in the database.
%%

%%
%% Override global options (shared by all ejabberd nodes in a cluster).
%%
%%override_global.

%%
%% Override local options (specific for this particular ejabberd node).
%%
%%override_local.

%%
%% Remove the Access Control Lists before new ones are added.
%%
%%override_acls.


%%%.   =========
%%%'   DEBUGGING

%%
%% loglevel: Verbosity of log files generated by ejabberd.
%% 0: No ejabberd log at all (not recommended)
%% 1: Critical
%% 2: Error
%% 3: Warning
%% 4: Info
%% 5: Debug
%%
{loglevel, 4}.


%%%.   ================
%%%'   SERVED HOSTNAMES

%%
%% hosts: Domains served by ejabberd.
%% You can define one or several, for example:
%% {hosts, ["example.net", "example.com", "example.org"]}.
%%
{host, {system, <<"WOCKY_HOST">>, <<"localhost">>}}.

%%
%% route_subdomains: Delegate subdomains to other XMPP servers.
%% For example, if this ejabberd serves example.org and you want
%% to allow communication with an XMPP server called im.example.org.
%%
%%{route_subdomains, s2s}.


%%%.   =================
%%%'   IQ CRASH BEHAVIOR

{iq_crash_response,
 {system, atom, <<"WOCKY_IQ_CRASH_RESPONSE">>, error_with_dump}}.


%%%.   ===============
%%%'   LISTENING PORTS

%%
%% listen: The ports ejabberd will listen on, which service each is handled
%% by and what options to start it with.
%%
{listen, [
  {5222, ejabberd_c2s, [
    {zlib, 4096},
    {access, c2s},
    {shaper, c2s_shaper},
    {max_stanza_size, 65536},
    {protocol_options, ["no_sslv3"]}
  ]},

  {5269, ejabberd_s2s_in, [
    {shaper, s2s_shaper},
    {max_stanza_size, 131072},
    {protocol_options, ["no_sslv3"]}
  ]},

  %% WS endpoint over HTTP
  {5280, ejabberd_cowboy, [
    {num_acceptors, 10},
    {transport_options, [{max_connections, 1024}]},
    {modules, [
      {"_", "/ws-xmpp", mod_websockets, [
        {ejabberd_service, [
          {access, all},
          {shaper_rule, fast}
        ]}
      ]}
      %% Uncomment to enable connection dropping or/and server-side pings
      %{timeout, 600000},
      %{ping_rate, 2000}
    ]}
  ]},

  %% MongooseIM HTTP API it's important to start it on localhost
  %% or some private interface only (not accessible from the outside)
  %% At least start it on different port which will be hidden behind firewall

  {8088, ejabberd_cowboy, [
    {num_acceptors, 10},
    {transport_options, [{max_connections, 1024}]},
    {modules, [
      {"localhost", "/api", mongoose_api_admin, []}
    ]}
  ]},

  {8089, ejabberd_cowboy, [
    {num_acceptors, 10},
    {transport_options, [{max_connections, 1024}]},
    {protocol_options, [{compress, true}]},
    {modules, [
      {"_", "/api/sse", lasse_handler, [mongoose_client_api_sse]},
      {"_", "/api/messages/[:with]", mongoose_client_api_messages, []},
      {"_", "/api/contacts/[:jid]", mongoose_client_api_contacts, []},
      {"_", "/api/rooms/[:id]", mongoose_client_api_rooms, []},
      {"_", "/api/rooms/:id/users/[:user]", mongoose_client_api_rooms_users, []},
      {"_", "/api/rooms/[:id]/messages", mongoose_client_api_rooms_messages, []}
    ]}
  ]}
]}.

%%
%% s2s_use_starttls: Enable STARTTLS + Dialback for S2S connections.
%% Allowed values are: false optional required required_trusted
%% You must specify a certificate file.
%%
{s2s_use_starttls, false}.

%%
%% s2s_certfile: Specify a certificate file.
%%
%%{s2s_certfile, "priv/ssl/fake_server.pem"}.

%% https://www.openssl.org/docs/apps/ciphers.html#CIPHER_STRINGS
%% {s2s_ciphers, "DEFAULT:!EXPORT:!LOW:!SSLv2"}.

%%
%% domain_certfile: Specify a different certificate for each served hostname.
%%
%%{domain_certfile, "example.org", "/path/to/example_org.pem"}.
%%{domain_certfile, "example.com", "/path/to/example_com.pem"}.

%%
%% S2S whitelist or blacklist
%%
%% Default s2s policy for undefined hosts.
%%
{s2s_default_policy, deny}.

%%
%% Allow or deny communication with specific servers.
%%
%%{ {s2s_host, "goodhost.org"}, allow}.
%%{ {s2s_host, "badhost.org"}, deny}.

{outgoing_s2s_port, 5299}.

%%
%% IP addresses predefined for specific hosts to skip DNS lookups.
%% Ports defined here take precedence over outgoing_s2s_port.
%% Examples:
%%
%% { {s2s_addr, "example-host.net"}, {127,0,0,1} }.
%% { {s2s_addr, "example-host.net"}, { {127,0,0,1}, 5269 } }.
%%{ {s2s_addr, "fed1"}, {127,0,0,1} }.

%%
%% Outgoing S2S options
%%
%% Preferred address families (which to try first) and connect timeout
%% in milliseconds.
%%
%%{outgoing_s2s_options, [ipv4, ipv6], 10000}.


%%%.   ==============
%%%'   SESSION BACKEND

% {sm_backend, {mnesia, []}}.
% {sm_backend, {redis, [
%   {pool_size, 10},
%   {worker_config, [{host, "localhost"}, {port, 6379}, {db, 1}]}
% ]}}.


%%%.   ==============
%%%'   AUTHENTICATION

%%
%% auth_method: Method used to authenticate the users.
%%
{auth_method, wocky}.
{auth_opts, [
  %% Store the passwords hashed for SCRAM:
  {password_format, scram},
  {scram_iterations, 4096} % default
]}.


%%%.   ==============
%%%'   DATABASE SETUP

%% Specifies what database is used over the ODBC layer
%% Can take values odbc, pgsql, mysql
{odbc_server_type, pgsql}.

%% PostgreSQL server:
%% This is the default and may be overriden by the top-level config files.
%{odbc_server, {pgsql, "localhost", 5432, "wocky", "wocky", "password"}}.

%% If you use PostgreSQL, have a large database, and need a
%% faster but inexact replacement for "select count(*) from users"
{pgsql_users_number_estimate, false}.

%% Number of connections to open to the database for each virtual host
{odbc_pool_size, 10}.

%% Enable the default database connection pool
{pool, odbc, default}.

%% Interval to make a dummy SQL request to keep the connections to the
%% database alive. Specify in seconds: for example 28800 means 8 hours
{odbc_keepalive_interval, undefined}.


%%%.   ===============
%%%'   TRAFFIC SHAPERS

%%
%% The "normal" shaper limits traffic speed to 1000 B/s
%%
{shaper, normal, {maxrate, 1000}}.

%%
%% The "fast" shaper limits traffic speed to 50000 B/s
%%
{shaper, fast, {maxrate, 50000}}.

%%
%% This option specifies the maximum number of elements in the queue
%% of the FSM. Refer to the documentation for details.
%%
{max_fsm_queue, 1500}.


%%%.   ====================
%%%'   ACCESS CONTROL LISTS

%%
%% The 'admin' ACL grants administrative privileges to XMPP accounts.
%% You can put here as many accounts as you want.
%%
%{acl, admin, {user, "alice", "localhost"}}.
%{acl, admin, {user, "a", "localhost"}}.

%%
%% Blocked users
%%
%%{acl, blocked, {user, "baduser", "example.org"}}.
%%{acl, blocked, {user, "test"}}.

%%
%% Local users: don't modify this line.
%%
{acl, local, {user_regexp, ""}}.


%%%.   ============
%%%'   ACCESS RULES

%% Maximum number of simultaneous sessions allowed for a single user:
{access, max_user_sessions, [{10, all}]}.

%% Maximum number of offline messages that users can have:
{access, max_user_offline_messages, [{5000, admin}, {100, all}]}.

%% This rule allows access only for local users:
{access, local, [{allow, local}]}.

%% Only non-blocked users can use c2s connections:
{access, c2s, [{deny, blocked}, {allow, all}]}.

%% For C2S connections, all users except admins use the "normal" shaper
{access, c2s_shaper, [{none, admin}, {normal, all}]}.

%% All S2S connections use the "fast" shaper
{access, s2s_shaper, [{fast, all}]}.

%% Admins of this server are also admins of the MUC service:
{access, muc_admin, [{allow, admin}]}.

%% Only accounts of the local ejabberd server can create rooms:
{access, muc_create, [{allow, local}]}.

%% All users are allowed to use the MUC service:
{access, muc, [{allow, all}]}.

%% In-band registration allows registration of any possible username.
%% To disable in-band registration, replace 'allow' with 'deny'.
{access, register, [{allow, all}]}.

%% By default the frequency of account registrations from the same IP
%% is limited to 1 account every 10 minutes. To disable, specify: infinity
{registration_timeout, infinity}.

%% Default settings for MAM.
%% To set non-standard value, replace 'default' with 'allow' or 'deny'.
%% Only user can access his/her archive by default.
%% An online user can read room's archive by default.
%% Only an owner can change settings and purge messages by default.
%% Empty list (i.e. `[]`) means `[{deny, all}]`.
{access, mam_set_prefs, [{default, all}]}.
{access, mam_get_prefs, [{default, all}]}.
{access, mam_lookup_messages, [{default, all}]}.
{access, mam_purge_single_message, [{default, all}]}.
{access, mam_purge_multiple_messages, [{default, all}]}.

%% 1 command of the specified type per second.
{shaper, mam_shaper, {maxrate, 1}}.
%% This shaper is primeraly for Mnesia overload protection during stress testing.
%% The limit is 1000 operations of each type per second.
{shaper, mam_global_shaper, {maxrate, 1000}}.

{access, mam_set_prefs_shaper, [{mam_shaper, all}]}.
{access, mam_get_prefs_shaper, [{mam_shaper, all}]}.
{access, mam_lookup_messages_shaper, [{mam_shaper, all}]}.
{access, mam_purge_single_message_shaper, [{mam_shaper, all}]}.
{access, mam_purge_multiple_messages_shaper, [{mam_shaper, all}]}.

{access, mam_set_prefs_global_shaper, [{mam_global_shaper, all}]}.
{access, mam_get_prefs_global_shaper, [{mam_global_shaper, all}]}.
{access, mam_lookup_messages_global_shaper, [{mam_global_shaper, all}]}.
{access, mam_purge_single_message_global_shaper, [{mam_global_shaper, all}]}.
{access, mam_purge_multiple_messages_global_shaper, [{mam_global_shaper, all}]}.


%%%.   ================
%%%'   DEFAULT LANGUAGE

%%
%% language: Default language used for server messages.
%%
{language, "en"}.


%%%.   ================
%%%'   MISCELLANEOUS

{all_metrics_are_global, false}.


%%%.   =======
%%%'   MODULES

%%
%% Modules enabled in all ejabberd virtual hosts.
%% For list of possible modules options, check documentation.
%%
{modules, [
  {mod_admin_extra, [{submods, [node, accounts, sessions, vcard,
                                roster, last, private, stanza, stats]}]},
  %% Standard modules that clients will expect
  {mod_disco, []},
  {mod_ping, []},
  {mod_private, []}, % Some clients behave badly without this
  {mod_stream_management, [
    {buffer_max, 100},
    {ack_freq, 1},
    {resume_timeout, 600}
  ]},
  {mod_mam, [add_archived_element]},
  {mod_mam_odbc_arch, [pm, no_writer]},
  {mod_mam_odbc_user, [pm]},
  {mod_mam_cache_user, [pm]},
  {mod_mam_odbc_async_pool_writer, [pm]},

  {mod_last, [{backend, odbc}]},
  {mod_offline, [
    {backend, odbc},
    {access_max_user_messages, max_user_offline_messages}
  ]},
  {mod_privacy, [{backend, wocky}]},

  %% New, Wocky-specific modules
  {mod_wocky_publishing, []},
  {mod_wocky_roster, []},
  {mod_wocky_mam, []},
  {mod_wocky_token, []},
  {mod_wocky_user, []},
  {mod_wocky_lookup, []},
  {mod_wocky_pep, []},
  {mod_wocky_conversations, []},
  {mod_wocky_notifications, []},
  {mod_wocky_bot, []},
  {mod_wocky_user_notify, []},
  {mod_wocky_multicast, []},
  {mod_wocky_privacy, []},
  {mod_wocky_honeybadger, []},
  {mod_wocky_traffic_log, [{expire, 604800}]}, % keep for 1 week
  {mod_wocky_tros, [{backend, s3}]},
  {mod_wocky_sasl_plain, []},
  {mod_wocky_sasl_wocky, []}
]}.


%%%.
%%%'

%%% Local Variables:
%%% mode: erlang
%%% End:
%%% vim: set filetype=erlang tabstop=2 foldmarker=%%%',%%%. foldmethod=marker:
%%%.
